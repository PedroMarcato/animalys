<ui:composition template="/WEB-INF/template/Layout.xhtml"
	xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:p="http://primefaces.org/ui">

	<ui:define name="titulo">Retirada de Medicamentos</ui:define>
	<f:metadata>
		<f:viewAction action="#{retiradaMedicamentoBean.inicializar()}" />
	</f:metadata>
	
	<ui:define name="content">
		<h:outputScript library="js" name="debug-upload.js" />
		<h:form id="formRetirada">
			<h1 class="aw-page-title">
				#{empty retiradaMedicamentoBean.retirada.idRetiradaMedicamento ? 'Nova Retirada de Medicamento' : 'Editar Retirada de Medicamento'}
			</h1>

			<p:messages id="messages" closable="true" />
			
			<p:toolbar>
				<p:toolbarGroup>
					<p:button value="Nova Retirada" icon="fa fa-plus"
						outcome="/estoque/retiradaMedicamento" />
					<p:commandButton value="Salvar" icon="fa fa-save"
						action="#{retiradaMedicamentoBean.salvar()}" 
						update="@form" />
					<p:commandButton value="Limpar" icon="fa fa-eraser"
						action="#{retiradaMedicamentoBean.limpar()}" 
						update="@form" immediate="true" />
				</p:toolbarGroup>
				<p:toolbarGroup align="right">
					<p:button value="Pesquisar Retiradas" icon="fa fa-search"
						outcome="/estoque/pesquisaRetiradaMedicamento" />
				</p:toolbarGroup>
			</p:toolbar>

			<div class="ui-fluid">
				<p:panelGrid columns="4" layout="grid"
					columnClasses="ui-grid-col-2, ui-grid-col-4, ui-grid-col-2, ui-grid-col-4"
					styleClass="panelgrid-noborder" style="margin-top: 20px">

					<p:outputLabel value="CPF do Proprietário" for="cpfProprietario" />
					<h:panelGroup>
						<p:inputMask id="cpfProprietario" mask="999.999.999-99"
							value="#{retiradaMedicamentoBean.cpfProprietario}"
							placeholder="Digite o CPF do proprietário" required="true">
							<p:ajax event="blur" 
								listener="#{retiradaMedicamentoBean.buscarProprietarioPorCpf()}" 
								update="nomeProprietario animalSelect messages" />
						</p:inputMask>
						<p:message for="cpfProprietario" />
					</h:panelGroup>

					<p:outputLabel value="Proprietário" for="nomeProprietario" />
					<p:inputText id="nomeProprietario"
						value="#{retiradaMedicamentoBean.retirada.proprietario.nome}"
						readonly="true" 
						placeholder="Proprietário será carregado após inserir CPF" />

					<p:outputLabel value="Animal" for="animalSelect" />
					<h:panelGroup>
						<p:selectOneMenu id="animalSelect"
                            required="true"
							value="#{retiradaMedicamentoBean.animalSelecionadoId}"
							disabled="#{empty retiradaMedicamentoBean.animaisProprietario}">
							<f:selectItem itemLabel="Selecione o animal" itemValue="#{null}" noSelectionOption="true" />
							<f:selectItems value="#{retiradaMedicamentoBean.animaisProprietario}"
								var="animal" 
								itemValue="#{animal.idAnimal}" 
								itemLabel="#{animal.nome} - #{animal.raca != null ? animal.raca.nome : 'Sem raça'}" />
							<p:ajax event="change" update="racaAnimal classificacaoIdade" />
						</p:selectOneMenu>
						<p:message for="animalSelect" />
					</h:panelGroup>

					<p:outputLabel value="Raça" for="racaAnimal" />
					<p:inputText id="racaAnimal"
						value="#{retiradaMedicamentoBean.retirada.animal != null and retiradaMedicamentoBean.retirada.animal.raca != null ? retiradaMedicamentoBean.retirada.animal.raca.nome : 'Não informada'}"
						readonly="true" 
						placeholder="Raça será exibida após selecionar o animal" />

					<p:outputLabel value="Classificação Etária" for="classificacaoIdade" />
					<p:inputText id="classificacaoIdade"
						value="#{retiradaMedicamentoBean.classificacaoIdade}"
						readonly="true" 
						placeholder="Classificação será exibida após selecionar o animal" />

					<p:outputLabel value="Medicamento" for="nomeMedicamento" />
					<h:panelGroup>
						<p:inputText id="nomeMedicamento"
							value="#{retiradaMedicamentoBean.retirada.nomeMedicamento}"
                            required="true"
							placeholder="Digite o nome do medicamento"
							maxlength="200" />
						<p:message for="nomeMedicamento" />
					</h:panelGroup>

					<p:outputLabel value="Quantidade" for="quantidade" />
					<h:panelGroup>
						<p:spinner id="quantidade"
                            required="true"
							value="#{retiradaMedicamentoBean.retirada.quantidade}"
							min="1"
							max="999" />
						<p:message for="quantidade" />
					</h:panelGroup>

					<p:outputLabel value="Data da Retirada" for="dataRetirada" />
					<h:panelGroup>
						<p:calendar id="dataRetirada"
                            required="true"
							value="#{retiradaMedicamentoBean.dataRetirada}"
							pattern="dd/MM/yyyy HH:mm"
							showTime="true"
							timeOnlyTitle="Escolha o horário"
							stepHour="1"
							stepMinute="15"
							locale="pt_BR" />
						<p:message for="dataRetirada" />
					</h:panelGroup>

				</p:panelGrid>

				<p:panelGrid columns="1" layout="grid"
					columnClasses="ui-grid-col-12"
					styleClass="panelgrid-noborder" style="margin-top: 10px">
					
					<p:outputLabel value="Observações" for="observacoes" />
					<p:inputTextarea id="observacoes"
						value="#{retiradaMedicamentoBean.retirada.observacoes}"
						rows="3"
						maxlength="500"
						placeholder="Observações sobre a retirada do medicamento (opcional)"
                        style="height: 400px;" />
				
				</p:panelGrid>

				<!-- Seção de Upload de Arquivo -->
				<p:panel header="Anexar Receita/Laudo (Imagem ou PDF)" styleClass="mt-3">
					<p:panelGrid columns="2" layout="grid" 
						columnClasses="ui-grid-col-6, ui-grid-col-6"
						styleClass="panelgrid-noborder">
						
						<h:panelGroup>
							<p:outputLabel for="fileUpload" value="Anexar Receita" style="display: none;"/>
							<p:fileUpload id="fileUpload"
								widgetVar="uploaderRetirada"
								fileUploadListener="#{retiradaMedicamentoBean.uploadListener}"
								mode="advanced"
								multiple="false"
								auto="true"
								showUploadButton="true"
								disabled="#{retiradaMedicamentoBean.hasArquivoAnexado()}"
								onstart="console.log('[retiradaMedicamento] upload.start', event);"
								oncomplete="console.log('[retiradaMedicamento] upload.complete', event);"
								onerror="console.log('[retiradaMedicamento] upload.error', event);"
								allowTypes="/(jpg|jpeg|png|gif|bmp|pdf)$/i"
								update=":formRetirada:messages :formRetirada"
								/>
							<p style="font-size: 0.9em; color: #666; margin-top: 162px;">
								Tipos permitidos: JPG, PNG, PDF (máx. 10MB)
							</p>
						</h:panelGroup>
						
						<h:panelGroup>
							<p:outputLabel value="Arquivo anexado:" style="font-weight: bold;" />
							<div style="margin-top: 10px;">
								<!-- Preview para imagem -->
								<h:panelGroup rendered="#{retiradaMedicamentoBean.arquivoImagemPreview}">
									<div style="width: 100%; padding: 10px 0; display: flex; border: 1px solid #ccc; border-radius: 4px;">
									<img src="#{retiradaMedicamentoBean.urlArquivoPreview}" title="Preview do documento"
										style="max-width: 200px; max-height: 200px; border: 1px solid #ccc; border-radius: 4px; margin: 0 auto;" />
									</div>
								</h:panelGroup>

								<!-- Preview específico para PDF: ícone centralizado -->
								<h:panelGroup rendered="#{retiradaMedicamentoBean.arquivoPdfPreview}">
									<div style="width: 100%; display:flex; justify-content:center; align-items:center; padding:20px 0;">
										<div style="width:140px; height:140px; border:3px solid #e74c3c; border-radius:6px; display:flex; justify-content:center; align-items:center;">
											<i class="fa fa-file-pdf-o" style="font-size:64px; color:#e74c3c;" title="Arquivo PDF"></i>
										</div>
									</div>
								</h:panelGroup>
								
								<!-- Link para PDF ou imagem -->
								<p:commandButton value="Visualizar Arquivo" 
									icon="fa fa-external-link"
									onclick="window.open('#{retiradaMedicamentoBean.urlArquivoPreview}', '_blank'); return false;"
									styleClass="ui-button-info"
									style="margin-top: 10px;"
									rendered="#{retiradaMedicamentoBean.hasArquivoAnexado()}" />
								
								<p:commandButton value="Remover Arquivo" 
									icon="fa fa-trash"
									action="#{retiradaMedicamentoBean.removerArquivoAnexado()}"
									update="@form"
									rendered="#{retiradaMedicamentoBean.hasArquivoAnexado()}"
									styleClass="ui-button-danger"
									style="margin-top: 10px;">
									<p:confirm header="Confirmação" 
										message="Deseja realmente remover este arquivo?" 
										icon="fa fa-exclamation-triangle" />
								</p:commandButton>
							</div>
						</h:panelGroup>
						
					</p:panelGrid>
				</p:panel>

			</div>
			
			<p:confirmDialog global="true" showEffect="fade" hideEffect="fade">
				<p:commandButton value="Sim" type="button" styleClass="ui-confirmdialog-yes" icon="fa fa-check" />
				<p:commandButton value="Não" type="button" styleClass="ui-confirmdialog-no" icon="fa fa-close" />
			</p:confirmDialog>
		</h:form>
	</ui:define>

</ui:composition>