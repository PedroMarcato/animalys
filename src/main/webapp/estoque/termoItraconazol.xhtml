<ui:composition template="/WEB-INF/template/Layout.xhtml" xmlns="http://www.w3.org/1999/xhtml"
    xmlns:h="http://java.sun.com/jsf/html" xmlns:f="http://java.sun.com/jsf/core"
    xmlns:ui="http://java.sun.com/jsf/facelets" xmlns:p="http://primefaces.org/ui" xmlns:o="http://omnifaces.org/ui">

    <f:metadata>
        <f:viewParam name="termo" value="#{termoItraconazolBean.termo}" converter="termoItraconazolConverter" />
        <f:viewAction action="#{termoItraconazolBean.inicializar}" />
    </f:metadata>

    <ui:define name="titulo">Termo de Compromisso - Itraconazol</ui:define>

    <ui:define name="content">
        <h:outputScript library="js" name="debug-upload.js" />
        <h:form id="frmTermo">
            <h1 class="aw-page-title">
                #{termoItraconazolBean.editando ? 'Edição de' : 'Nova'} Retirada - Itraconazol
            </h1>

            <p:messages id="messages" closable="true" />

            <p:toolbar>
                <p:toolbarGroup>
                    <p:commandButton value="Salvar" icon="fa fa-save" action="#{termoItraconazolBean.salvar}" update="@form" />
                </p:toolbarGroup>
                <p:toolbarGroup align="right">
                    <p:button value="Pesquisa" icon="fa fa-search" outcome="/estoque/pesquisaTermoItraconazol" />
                </p:toolbarGroup>
            </p:toolbar>

            <div class="ui-fluid">
                <p:panelGrid columns="4" layout="grid" columnClasses="ui-grid-col-2, ui-grid-col-4, ui-grid-col-2, ui-grid-col-4" 
                    styleClass="panelgrid-noborder" style="margin-top: 20px">

                    <p:outputLabel value="CPF do Proprietário:" for="cpfProprietario" />
                    <h:panelGroup>
                        <p:inputMask id="cpfProprietario" mask="999.999.999-99"
                            value="#{termoItraconazolBean.cpfProprietario}"
                            placeholder="Digite o CPF do proprietário" required="true"
                            readonly="#{termoItraconazolBean.editando}">
                            <p:ajax event="blur" 
                                listener="#{termoItraconazolBean.buscarProprietarioPorCpf()}" 
                                update="nomeProprietario animalSelect messages" />
                        </p:inputMask>
                        <p:message for="cpfProprietario" />
                    </h:panelGroup>

                    <p:outputLabel value="Proprietário:" for="nomeProprietario" />
                    <p:inputText id="nomeProprietario"
                        value="#{termoItraconazolBean.proprietarioSelecionado != null ? termoItraconazolBean.proprietarioSelecionado.nome : ''}"
                        readonly="true" 
                        placeholder="Proprietário será carregado após inserir CPF" />

                    <p:outputLabel value="Animal:" for="animalSelect" />
                    <h:panelGroup>
                        <p:selectOneMenu id="animalSelect"
                            required="true"
                            value="#{termoItraconazolBean.termo.animal}"
                            converter="animalConverter"
                            disabled="#{empty termoItraconazolBean.animaisProprietario or termoItraconazolBean.editando}">
                            <f:selectItem itemLabel="Selecione o animal" noSelectionOption="true" />
                            <f:selectItems value="#{termoItraconazolBean.animaisProprietario}"
                                var="animal" 
                                itemValue="#{animal}" 
                                itemLabel="#{animal.nome} - #{animal.raca != null ? animal.raca.nome : 'Sem raça'}" />
                            <p:ajax event="change" listener="#{termoItraconazolBean.onAnimalChange}" process="@this" update="messages dadosAnimalContainer" />
                        </p:selectOneMenu>
                        <p:message for="animalSelect" />
                    </h:panelGroup>

                    <p:outputLabel value="Medicamento:" />
                    <p:outputLabel value="Itraconazol (para tratamento de esporotricose)" styleClass="fw-bold" />

                    <p:outputLabel value="Observações:" for="observacoes" />
                    <p:inputTextarea id="observacoes" value="#{termoItraconazolBean.termo.observacoes}" 
                        rows="3" maxlength="1000" readonly="#{termoItraconazolBean.editando}" />
                </p:panelGrid>

                <!-- Dados do Animal -->
                <h:panelGroup id="dadosAnimalContainer">
                    <p:panel header="Dados do Animal" styleClass="mt-3" rendered="#{termoItraconazolBean.mostrarDadosAnimal}">
                    <p:panelGrid columns="4" layout="grid" columnClasses="ui-grid-col-2, ui-grid-col-4, ui-grid-col-2, ui-grid-col-4" 
                        styleClass="panelgrid-noborder">
                        
                        <p:outputLabel value="Nome:" />
                        <p:inputText value="#{termoItraconazolBean.termo.animal.nome}" readonly="true" />
                        
                        <p:outputLabel value="Pelagem (Cor):" />
                        <p:inputText value="#{termoItraconazolBean.termo.animal.cor}" readonly="true" />
                        
                        <p:outputLabel value="Espécie:" />
                        <p:inputText value="#{termoItraconazolBean.termo.animal.raca != null and termoItraconazolBean.termo.animal.raca.especie != null ? termoItraconazolBean.termo.animal.raca.especie.nome : 'Não informada'}" readonly="true" />
                        
                        <p:outputLabel value="Porte:" for="porteAnimal" />
                        <h:panelGroup>
                            <p:selectOneMenu id="porteAnimal" value="#{termoItraconazolBean.termo.porteAnimal}" required="true"
                                disabled="#{termoItraconazolBean.editando}">
                                <f:selectItem itemLabel="Selecione o porte" noSelectionOption="true" />
                                <f:selectItem itemLabel="Pequeno" itemValue="Pequeno" />
                                <f:selectItem itemLabel="Médio" itemValue="Médio" />
                                <f:selectItem itemLabel="Grande" itemValue="Grande" />
                                <f:selectItem itemLabel="Gigante" itemValue="Gigante" />
                            </p:selectOneMenu>
                            <p:message for="porteAnimal" />
                        </h:panelGroup>
                        
                        <p:outputLabel value="Sexo:" />
                        <p:inputText value="#{termoItraconazolBean.termo.animal.sexo != null ? termoItraconazolBean.termo.animal.sexo.descricao : 'Não informado'}" readonly="true" />
                        
                        <p:outputLabel value="Idade:" />
                        <p:inputText value="#{termoItraconazolBean.termo.animal.idade}" readonly="true" />
                        
                        <p:outputLabel value="Microchip:" />
                        <p:inputText value="#{termoItraconazolBean.termo.animal.numeroMicrochip}" readonly="true" />
                        
                        <p:outputLabel value="Castrado:" />
                        <p:inputText value="#{termoItraconazolBean.termo.animal.status.name() == 'CASTRADO' ? 'Sim' : 'Não'}" readonly="true" />
                        
                    </p:panelGrid>
                </p:panel>
                </h:panelGroup>

                <!-- Seção do Termo de Compromisso 
                <h3 style="margin-top: 30px">ANEXO VI – Termo de Compromisso - Fornecimento do Itraconazol para esporotricose animal</h3>
                
                <p:panel header="Termo de Compromisso" style="margin-top: 10px">
                    <p>Atendendo às orientações e recomendações recebidas por meio da Secretaria Municipal de Saúde / Centro de Controle Animal.</p>
                    
                    <p><strong>Tutor(a) ou responsável pelo animal abaixo descrito:</strong></p>
                    
                    <p:panelGrid columns="2" layout="grid" columnClasses="ui-grid-col-6, ui-grid-col-6" 
                        styleClass="panelgrid-noborder" rendered="#{termoItraconazolBean.termo.animal != null}">
                        <p:outputLabel value="Nome: #{termoItraconazolBean.termo.animal.proprietario.nome}" />
                        <p:outputLabel value="CPF: #{termoItraconazolBean.termo.animal.proprietario.cpf}" />
                        <p:outputLabel value="Endereço: #{termoItraconazolBean.termo.animal.proprietario.endereco.logradouro}" />
                        <p:outputLabel value="Cidade: #{termoItraconazolBean.termo.animal.proprietario.endereco.cidade}" />
                        <p:outputLabel value="Telefone: #{termoItraconazolBean.termo.animal.proprietario.contato.telefone}" />
                        <p:outputLabel value="Celular: #{termoItraconazolBean.termo.animal.proprietario.contato.celular}" />
                    </p:panelGrid>

                    <p><strong>Animal:</strong></p>
                    <p:panelGrid columns="2" layout="grid" columnClasses="ui-grid-col-3, ui-grid-col-3" 
                        styleClass="panelgrid-noborder" rendered="#{termoItraconazolBean.termo.animal != null}">
                        <p:outputLabel value="Nome: #{termoItraconazolBean.termo.animal.nome}" />
                        <p:outputLabel value="Pelagem: #{termoItraconazolBean.termo.animal.cor}" />
                        <p:outputLabel value="Espécie: #{termoItraconazolBean.termo.animal.raca.especie.nome}" />
                        <p:outputLabel value="Porte: #{termoItraconazolBean.termo.porteAnimal}" />
                        <p:outputLabel value="Sexo: #{termoItraconazolBean.termo.animal.sexo.descricao}" />
                        <p:outputLabel value="Idade: #{termoItraconazolBean.termo.animal.idade}" />
                        <p:outputLabel value="Microchip: #{termoItraconazolBean.termo.animal.numeroMicrochip}" />
                        <p:outputLabel value="Castrado: #{termoItraconazolBean.termo.animal.status.name() == 'CASTRADO' ? 'Sim' : 'Não'}" />
                    </p:panelGrid>

                    <h:outputText value="Fui devidamente informado(a), estou ciente e de acordo que:" style="font-weight: bold; margin-top: 20px; display: block;" />
                    
                    <ul style="margin-top: 10px; line-height: 1.6;">
                        <li>A esporotricose é uma doença causada por um fungo e pode ser transmitida ao ser humano por mordeduras ou arranhaduras de animais doentes ou pelo contato de mucosa, cortes ou feridas com material contaminado (secreção das feridas);</li>
                        <li>O animal descrito acima é de minha responsabilidade e comprometo-me a medicá-lo de acordo com as instruções fornecidas pelos médicos veterinários durante todo o tempo que durar o tratamento;</li>
                        <li>Comprometo-me a levar o animal para reavaliação mensal e buscar a medicação de forma a não haver interrupção do tratamento (ficar o animal dias sem medicação);</li>
                        <li>Responsabilizo-me em manter o animal sempre domiciliado, evitando contato com animais estranhos para prevenção da reinfecção ou a transmissão para outros animais ou pessoas;</li>
                        <li>A falta de continuidade do tratamento e a não domiciliação do animal pode causar disseminação da doença para outros animais e pessoas;</li>
                        <li>Concordo que a Vigilância municipal realize acompanhamento periódico para verificar condições de saúde referentes à esporotricose;</li>
                        <li>Em caso do animal vir a óbito durante o tratamento, devo entrar em contato com o Centro de Controle Animal para a correta destinação, evitando contaminação ambiental.</li>
                    </ul>
                </p:panel> -->

                <!-- Controle de Acompanhamento Mensal (parecido com Retirada de Ração) -->
                <p:panel header="Controle de Acompanhamento Mensal" styleClass="mt-3">
                    <p:panelGrid columns="4" layout="grid" columnClasses="ui-grid-col-1, ui-grid-col-2, ui-grid-col-1, ui-grid-col-2" 
                        styleClass="panelgrid-noborder">

                        <p:outputLabel value="1º mês:" />
                        <p:calendar id="data1Mes" value="#{termoItraconazolBean.termo.data1Mes}" pattern="dd/MM/yyyy" mask="99/99/9999" />
                        <p:outputLabel value="Quantidade 1º mês:" for="qtd1Mes" />
                        <p:inputNumber id="qtd1Mes" value="#{termoItraconazolBean.termo.quantidade1Mes}" decimalPlaces="0" minValue="0" />

                        <p:outputLabel value="2º mês:" />
                        <p:calendar id="data2Mes" value="#{termoItraconazolBean.termo.data2Mes}" pattern="dd/MM/yyyy" mask="99/99/9999" />
                        <p:outputLabel value="Quantidade 2º mês:" for="qtd2Mes" />
                        <p:inputNumber id="qtd2Mes" value="#{termoItraconazolBean.termo.quantidade2Mes}" decimalPlaces="0" minValue="0" />

                        <p:outputLabel value="3º mês:" />
                        <p:calendar id="data3Mes" value="#{termoItraconazolBean.termo.data3Mes}" pattern="dd/MM/yyyy" mask="99/99/9999" />
                        <p:outputLabel value="Quantidade 3º mês:" for="qtd3Mes" />
                        <p:inputNumber id="qtd3Mes" value="#{termoItraconazolBean.termo.quantidade3Mes}" decimalPlaces="0" minValue="0" />

                        <p:outputLabel value="4º mês:" />
                        <p:calendar id="data4Mes" value="#{termoItraconazolBean.termo.data4Mes}" pattern="dd/MM/yyyy" mask="99/99/9999" />
                        <p:outputLabel value="Quantidade 4º mês:" for="qtd4Mes" />
                        <p:inputNumber id="qtd4Mes" value="#{termoItraconazolBean.termo.quantidade4Mes}" decimalPlaces="0" minValue="0" />

                        <p:outputLabel value="5º mês:" />
                        <p:calendar id="data5Mes" value="#{termoItraconazolBean.termo.data5Mes}" pattern="dd/MM/yyyy" mask="99/99/9999" />
                        <p:outputLabel value="Quantidade 5º mês:" for="qtd5Mes" />
                        <p:inputNumber id="qtd5Mes" value="#{termoItraconazolBean.termo.quantidade5Mes}" decimalPlaces="0" minValue="0" />

                        <p:outputLabel value="6º mês:" />
                        <p:calendar id="data6Mes" value="#{termoItraconazolBean.termo.data6Mes}" pattern="dd/MM/yyyy" mask="99/99/9999" />
                        <p:outputLabel value="Quantidade 6º mês:" for="qtd6Mes" />
                        <p:inputNumber id="qtd6Mes" value="#{termoItraconazolBean.termo.quantidade6Mes}" decimalPlaces="0" minValue="0" />

                        <p:outputLabel value="7º mês:" />
                        <p:calendar id="data7Mes" value="#{termoItraconazolBean.termo.data7Mes}" pattern="dd/MM/yyyy" mask="99/99/9999" />
                        <p:outputLabel value="Quantidade 7º mês:" for="qtd7Mes" />
                        <p:inputNumber id="qtd7Mes" value="#{termoItraconazolBean.termo.quantidade7Mes}" decimalPlaces="0" minValue="0" />

                    </p:panelGrid>
                </p:panel>

                <!-- Seção de Upload de Arquivo -->
                <p:panel header="Anexar Receita/Laudo (Imagem ou PDF)" styleClass="mt-3">
                    <p:panelGrid columns="2" layout="grid" 
                        columnClasses="ui-grid-col-6, ui-grid-col-6"
                        styleClass="panelgrid-noborder">
                        
                        <h:panelGroup>
                            <p:outputLabel value="Anexar Receita" for="fileUpload" style="display: none;" />
                            <!-- Ajustado para espelhar o comportamento do upload em retiradaMedicamento.xhtml -->
                            <p:fileUpload id="fileUpload"
                                widgetVar="uploaderTermo"
                                fileUploadListener="#{termoItraconazolBean.uploadListener}"
                                mode="advanced"
                                multiple="false"
                                auto="true"
                                showUploadButton="true"
                                disabled="#{termoItraconazolBean.hasArquivoAnexado()}"
                                onstart="console.log('[termoItraconazol] upload.start', event);"
                                oncomplete="console.log('[termoItraconazol] upload.complete', event);"
                                onerror="console.log('[termoItraconazol] upload.error', event);"
                                allowTypes="/(jpg|jpeg|png|gif|bmp|pdf)$/i"
                                process="@this"
                                update=":frmTermo:messages :frmTermo:arquivoPreview :frmTermo:fileUpload"/>
                            <p style="font-size: 0.9em; color: #666; margin-top: 162px;">
                                Tipos permitidos: JPG, PNG, PDF (máx. 10MB)
                            </p>
                        </h:panelGroup>
                        
                        <h:panelGroup id="arquivoPreview">
                            <p:outputLabel value="Arquivo anexado:" style="font-weight: bold;" />
                            <div style="margin-top: 10px;">
                                <!-- Preview para imagem -->
                                <h:panelGroup rendered="#{termoItraconazolBean.arquivoImagemPreview}">
                                    <div style="width: 100%; display: flex; border: solid 1px #ccc; border-radius: 4px; padding: 10px 0;">
                                    <img src="#{termoItraconazolBean.urlArquivoPreview}" title="Preview do documento"
                                        style="max-width: 200px; max-height: 200px; border: 1px solid #ccc; border-radius: 4px; margin: 0 auto;" />
                                    </div>
                                </h:panelGroup>

                                <!-- Preview específico para PDF: ícone centralizado -->
                                <h:panelGroup rendered="#{termoItraconazolBean.arquivoPdfPreview}">
                                    <div style="width: 100%; display:flex; justify-content:center; align-items:center; padding:20px 0;">
                                        <div style="width:140px; height:140px; border:3px solid #e74c3c; border-radius:6px; display:flex; justify-content:center; align-items:center;">
                                            <i class="fa fa-file-pdf-o" style="font-size:64px; color:#e74c3c;" title="Arquivo PDF"></i>
                                        </div>
                                    </div>
                                </h:panelGroup>
                                
                                <!-- Link para PDF ou imagem -->
                                <p:commandButton value="Visualizar Arquivo" 
                                    icon="fa fa-external-link"
                                    onclick="window.open('#{termoItraconazolBean.urlArquivoPreview}', '_blank'); return false;"
                                    styleClass="ui-button-info"
                                    style="margin-top: 10px;"
                                    rendered="#{termoItraconazolBean.hasArquivoAnexado()}" />
                                
                                <p:commandButton value="Remover Arquivo" 
                                    icon="fa fa-trash"
                                    action="#{termoItraconazolBean.removerArquivoAnexado()}"
                                    update="@form"
                                    rendered="#{termoItraconazolBean.hasArquivoAnexado()}"
                                    styleClass="ui-button-danger"
                                    style="margin-top: 10px;">
                                    <p:confirm header="Confirmação" 
                                        message="Deseja realmente remover este arquivo?" 
                                        icon="fa fa-exclamation-triangle" />
                                </p:commandButton>
                            </div>
                        </h:panelGroup>
                        
                    </p:panelGrid>
                </p:panel>
            </div>
            
            <p:confirmDialog global="true" showEffect="fade" hideEffect="fade">
                <p:commandButton value="Sim" type="button" styleClass="ui-confirmdialog-yes" icon="fa fa-check" />
                <p:commandButton value="Não" type="button" styleClass="ui-confirmdialog-no" icon="fa fa-close" />
            </p:confirmDialog>
        </h:form>
    </ui:define>
</ui:composition>