<ui:composition template="/WEB-INF/template/Layout.xhtml"
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:h="http://java.sun.com/jsf/html"
    xmlns:f="http://java.sun.com/jsf/core"
    xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:p="http://primefaces.org/ui"
    xmlns:o="http://omnifaces.org/ui">

    <ui:define name="titulo">Cadastro de Ficha Clínica</ui:define>

    <ui:define name="content">
        <h:form id="form">
            <h1 class="aw-page-title">Cadastro de Ficha Clínica</h1>

            <p:messages id="msg" closable="true" />

            <p:toolbar>
                <p:toolbarGroup>
                    <p:commandButton value="Salvar Atendimento" 
                                   icon="fa fa-save" 
                                   id="botaoSalvar"
                                   action="#{cadastroFichaClinicaBean.salvarAtendimento}" 
                                   update="@form"
                                   rendered="#{cadastroFichaClinicaBean.mostrarFormularioAtendimento}" />
                    <p:commandButton value="Cancelar" 
                                   icon="fa fa-times" 
                                   id="botaoCancelar"
                                   action="#{cadastroFichaClinicaBean.cancelarAtendimento}" 
                                   update="@form"
                                   rendered="#{cadastroFichaClinicaBean.mostrarFormularioAtendimento}"
                                   style="margin-left: 10px;" />
                </p:toolbarGroup>
                <p:toolbarGroup align="right">
                    <p:button value="Voltar" 
                             icon="fa fa-arrow-left"
                             outcome="/relatorios/historicoClientes.xhtml" />
                </p:toolbarGroup>
            </p:toolbar>

            <!-- Etapa 1: Pesquisa do Proprietário -->
            <p:fieldset legend="1. Pesquisar Proprietário" style="margin-top: 20px;">
                <p:panelGrid columns="3" layout="grid" 
                           columnClasses="ui-grid-col-2, ui-grid-col-4, ui-grid-col-2"
                           styleClass="panelgrid-noborder">
                    
                    <p:outputLabel value="CPF do Proprietário:" for="cpfPesquisa" />
                    <p:inputMask id="cpfPesquisa" 
                                value="#{cadastroFichaClinicaBean.cpfPesquisa}"
                                mask="999.999.999-99" 
                                placeholder="000.000.000-00" />
                    <p:commandButton value="Pesquisar" 
                                   icon="fa fa-search"
                                   action="#{cadastroFichaClinicaBean.pesquisarProprietarioPorCpf}"
                                   update="@form" />
                </p:panelGrid>

                <!-- Dados do Proprietário Encontrado -->
                <p:panelGrid columns="2" layout="grid"
                           columnClasses="ui-grid-col-1, ui-grid-col-6"
                           styleClass="panelgrid-noborder" 
                           style="margin-top: 15px;"
                           rendered="#{not empty cadastroFichaClinicaBean.proprietarioSelecionado}">
                    
                    <p:outputLabel value="Proprietário:" style="font-weight: bold" />
                    <p:outputLabel value="#{cadastroFichaClinicaBean.proprietarioSelecionado.nome}" />
                    
                    <p:outputLabel value="CPF:" style="font-weight: bold" />
                    <p:outputLabel value="#{cadastroFichaClinicaBean.proprietarioSelecionado.cpf}" />
                </p:panelGrid>
            </p:fieldset>

            <!-- Etapa 2: Seleção do Animal -->
            <p:fieldset legend="2. Selecionar Animal" 
                       rendered="#{not empty cadastroFichaClinicaBean.animaisDoProprietario}"
                       style="margin-top: 20px;">
                
                <p:panelGrid columns="2" layout="grid"
                           columnClasses="ui-grid-col-2, ui-grid-col-4"
                           styleClass="panelgrid-noborder">
                    
                    <p:outputLabel value="Animal:" for="animalSelect" />
                    <p:selectOneMenu id="animalSelect" 
                                   value="#{cadastroFichaClinicaBean.animalSelecionado}"
                                   converter="omnifaces.SelectItemsConverter">
                        <f:selectItem itemLabel="Selecione o animal" itemValue="#{null}" />
                        <f:selectItems value="#{cadastroFichaClinicaBean.animaisDoProprietario}" 
                                      var="animal"
                                      itemLabel="#{animal.nome} - #{animal.raca.especie.nome} - #{animal.raca.nome}" 
                                      itemValue="#{animal}" />
                        <p:ajax listener="#{cadastroFichaClinicaBean.selecionarAnimal}" 
                               update="@form" />
                    </p:selectOneMenu>
                </p:panelGrid>

                <!-- Dados do Animal Selecionado -->
                <p:panelGrid columns="2" layout="grid"
                           columnClasses="ui-grid-col-1, ui-grid-col-6"
                           styleClass="panelgrid-noborder" 
                           style="margin-top: 15px;"
                           rendered="#{not empty cadastroFichaClinicaBean.animalSelecionado}">
                    
                    <p:outputLabel value="Nome:" style="font-weight: bold" />
                    <p:outputLabel value="#{cadastroFichaClinicaBean.animalSelecionado.nome}" />
                    
                    <p:outputLabel value="Espécie:" style="font-weight: bold" />
                    <p:outputLabel value="#{cadastroFichaClinicaBean.animalSelecionado.raca.especie.nome}" />
                    
                    <p:outputLabel value="Raça:" style="font-weight: bold" />
                    <p:outputLabel value="#{cadastroFichaClinicaBean.animalSelecionado.raca.nome}" />
                    
                    <p:outputLabel value="Sexo:" style="font-weight: bold" />
                    <p:outputLabel value="#{cadastroFichaClinicaBean.animalSelecionado.sexo.descricao}" />
                    
                    <p:outputLabel value="Idade:" style="font-weight: bold" />
                    <p:outputLabel value="#{cadastroFichaClinicaBean.animalSelecionado.idade}" />

                    <p:outputLabel value="Microchip:" style="font-weight: bold" />
                    <h:panelGroup>
                        <p:outputLabel value="#{cadastroFichaClinicaBean.animalSelecionado.numeroMicrochip}" 
                                      rendered="#{not empty cadastroFichaClinicaBean.animalSelecionado.numeroMicrochip}" />
                        <p:outputLabel value="Sem Microchip" 
                                      style="color: #999999; font-style: italic;"
                                      rendered="#{empty cadastroFichaClinicaBean.animalSelecionado.numeroMicrochip}" />
                    </h:panelGroup>
                </p:panelGrid>
            </p:fieldset>

            <!-- Etapa 3: Histórico de Atendimentos -->
            <p:fieldset legend="3. Histórico de Atendimentos" 
                       rendered="#{not empty cadastroFichaClinicaBean.animalSelecionado}"
                       style="margin-top: 20px;">
                
                <p:commandButton value="Novo Atendimento" 
                               icon="fa fa-plus"
                               action="#{cadastroFichaClinicaBean.novoAtendimento}"
                               update="@form"
                               rendered="#{not cadastroFichaClinicaBean.mostrarFormularioAtendimento}"
                               style="margin-bottom: 15px;" 
                               styleClass="ui-button-success" />

                <h:outputText value="Total de atendimentos: #{cadastroFichaClinicaBean.atendimentosDoAnimal.size()}"
                             rendered="#{not empty cadastroFichaClinicaBean.atendimentosDoAnimal}"
                             style="font-weight: bold; margin-left: 15px;" />

                <p:dataTable id="atendimentosTable" 
                           value="#{cadastroFichaClinicaBean.atendimentosDoAnimal}" 
                           var="atendimento"
                           emptyMessage="Nenhum atendimento encontrado"
                           rendered="#{not empty cadastroFichaClinicaBean.atendimentosDoAnimal}"
                           style="margin-top: 15px;">
                    
                    <p:column headerText="Data" style="width: 120px;">
                        <h:outputText value="#{atendimento.dataAtendimentoFormatada}" />
                    </p:column>
                    
                    <p:column headerText="Tipo">
                        <h:outputText value="#{atendimento.tipoAtendimento == 'CONSULTA' ? 'Consulta Clínica' : 'Castração'}" />
                    </p:column>
                    
                    <p:column headerText="Profissional">
                        <h:outputText value="#{atendimento.profissional.nome}" />
                    </p:column>
                    
                    <p:column headerText="Diagnóstico">
                        <h:outputText value="#{atendimento.diagnostico}" escape="false" />
                    </p:column>
                </p:dataTable>
            </p:fieldset>

            <!-- Formulário de Novo Atendimento -->
            <p:fieldset legend="4. Novo Atendimento" 
                       rendered="#{cadastroFichaClinicaBean.mostrarFormularioAtendimento}"
                       style="margin-top: 20px;">
                
                <p:tabView id="tabViewAtendimento">
                    
                    <!-- Aba: Dados Gerais -->
                    <p:tab title="Dados Gerais">
                        <p:panelGrid columns="2" layout="grid"
                                   columnClasses="ui-grid-col-2, ui-grid-col-4"
                                   styleClass="panelgrid-noborder">
                            
                            <p:outputLabel value="Tipo de Atendimento:" for="tipoAtendimento" />
                            <p:selectOneRadio id="tipoAtendimento" 
                                            value="#{cadastroFichaClinicaBean.tipoAtendimentoSelecionado}"
                                            layout="lineDirection">
                                <f:selectItem itemLabel="Consulta Clínica" itemValue="CONSULTA" />
                                <f:selectItem itemLabel="Castração" itemValue="CASTRACAO" />
                                <p:ajax update="tabViewAtendimento" />
                            </p:selectOneRadio>

                            <p:outputLabel value="Data do Atendimento:" for="dataAtendimento" />
                            <p:calendar id="dataAtendimento" 
                                      value="#{cadastroFichaClinicaBean.novoAtendimento.data.time}"
                                      pattern="dd/MM/yyyy HH:mm" 
                                      locale="pt" 
                                      mask="99/99/9999 99:99" />

                            <p:outputLabel value="Profissional:" for="profissional" />
                            <p:selectOneMenu id="profissional" 
                                           value="#{cadastroFichaClinicaBean.profissionalSelecionado}"
                                           required="true" 
                                           requiredMessage="O profissional deve ser selecionado">
                                <f:selectItem itemLabel="Selecione o profissional" itemValue="#{null}" />
                                <f:selectItems value="#{cadastroFichaClinicaBean.profissionaisSelect}" 
                                              var="prof"
                                              itemLabel="#{prof.nome}" 
                                              itemValue="#{prof}" />
                            </p:selectOneMenu>
                        </p:panelGrid>

                        <!-- Dados da Consulta (só aparece se for consulta) -->
                        <p:panelGrid columns="2" layout="grid"
                                   columnClasses="ui-grid-col-2, ui-grid-col-4"
                                   styleClass="panelgrid-noborder"
                                   style="margin-top: 15px;"
                                   rendered="#{cadastroFichaClinicaBean.tipoAtendimentoSelecionado eq 'CONSULTA'}">
                            
                            <p:outputLabel value="Peso (kg):" for="peso" />
                            <p:inputNumber id="peso" 
                                         value="#{cadastroFichaClinicaBean.novoAtendimento.peso}"
                                         decimalPlaces="2" 
                                         minValue="0" />

                            <p:outputLabel value="Escore Corporal:" for="escoreCorporal" />
                            <p:inputNumber id="escoreCorporal" 
                                         value="#{cadastroFichaClinicaBean.novoAtendimento.escoreCorporal}"
                                         decimalPlaces="1" />

                            <p:outputLabel value="FC (bpm):" for="fc" />
                            <p:inputText id="fc" 
                                       value="#{cadastroFichaClinicaBean.novoAtendimento.fc}" />

                            <p:outputLabel value="FR (irpm):" for="fr" />
                            <p:inputText id="fr" 
                                       value="#{cadastroFichaClinicaBean.novoAtendimento.fr}" />

                            <p:outputLabel value="Temperatura (°C):" for="temperatura" />
                            <p:inputNumber id="temperatura" 
                                         value="#{cadastroFichaClinicaBean.novoAtendimento.temperatura}"
                                         decimalPlaces="1" />

                            <p:outputLabel value="Tratamento:" for="tratamento" />
                            <p:selectOneMenu id="tratamento" 
                                           value="#{cadastroFichaClinicaBean.novoAtendimento.tratamento}"
                                           converter="omnifaces.SelectItemsConverter">
                                <f:selectItem itemLabel="Selecione" itemValue="" />
                                <f:selectItems value="#{cadastroFichaClinicaBean.tratamentos}" 
                                              var="trat" 
                                              itemLabel="#{trat.nome}"
                                              itemValue="#{trat}" />
                            </p:selectOneMenu>
                        </p:panelGrid>
                    </p:tab>

                    <!-- Aba: Diagnóstico/Parecer -->
                    <p:tab title="Diagnóstico/Parecer">
                        <p:panelGrid columns="1" layout="grid" 
                                   columnClasses="ui-grid-col-12"
                                   styleClass="panelgrid-noborder">

                            <p:textEditor id="diagnostico" 
                                        value="#{cadastroFichaClinicaBean.novoAtendimento.diagnostico}"
                                        height="300" 
                                        style="margin-bottom:10px"
                                        required="true" 
                                        requiredMessage="Informe o diagnóstico/parecer!" />
                        </p:panelGrid>
                    </p:tab>

                    <!-- Aba: Procedimentos (só para castração) -->
                    <p:tab title="Procedimentos" 
                          rendered="#{cadastroFichaClinicaBean.tipoAtendimentoSelecionado eq 'CASTRACAO'}">
                        
                        <p:panelGrid columns="2" layout="grid"
                                   columnClasses="ui-grid-col-2, ui-grid-col-10"
                                   styleClass="panelgrid-noborder">

                            <p:outputLabel value="Procedimento" for="procedimento" />
                            <h:panelGroup>
                                <p:autoComplete id="procedimento" 
                                              dropdown="true"
                                              value="#{cadastroFichaClinicaBean.procedimentoSelecionado}"
                                              completeMethod="#{cadastroFichaClinicaBean.completarProcedimento}"
                                              var="pro" 
                                              itemLabel="#{pro.nome}" 
                                              itemValue="#{pro}"
                                              forceSelection="true" 
                                              minQueryLength="2" 
                                              maxResults="10" />

                                <p:commandButton value="Adicionar" 
                                               icon="fa fa-plus"
                                               action="#{cadastroFichaClinicaBean.adicionarProcedimento}"
                                               update="procedimentosTable, procedimento"
                                               style="margin-left: 10px;" />
                            </h:panelGroup>
                        </p:panelGrid>

                        <p:dataTable id="procedimentosTable" 
                                   style="margin-top: 20px"
                                   emptyMessage="Nenhum procedimento adicionado!" 
                                   rows="5"
                                   value="#{cadastroFichaClinicaBean.procedimentosSelecionados}"
                                   var="proc">
                            
                            <p:column headerText="ID">
                                <h:outputText value="#{proc.idProcedimento}" />
                            </p:column>
                            
                            <p:column headerText="Nome">
                                <h:outputText value="#{proc.nome}" />
                            </p:column>
                            
                            <p:column headerText="Ações" style="width: 120px; text-align: center">
                                <p:commandButton icon="ui-icon-trash" 
                                               title="Excluir"
                                               oncomplete="PF('confirmacaoExclusao').show()" 
                                               process="@this"
                                               update="form:tabViewAtendimento:confirmacaoExclusaoDialog">
                                    <f:setPropertyActionListener
                                        target="#{cadastroFichaClinicaBean.procedimentoSelecionado}"
                                        value="#{proc}" />
                                </p:commandButton>
                            </p:column>
                        </p:dataTable>

                        <p:confirmDialog header="Remover Procedimento"
                                       message="Tem certeza que deseja remover este procedimento?"
                                       widgetVar="confirmacaoExclusao" 
                                       id="confirmacaoExclusaoDialog">
                            <p:button value="Não" 
                                     icon="fa fa-close"
                                     onclick="PF('confirmacaoExclusao').hide(); return false;" />
                            <p:commandButton value="Sim" 
                                           icon="fa fa-check"
                                           oncomplete="PF('confirmacaoExclusao').hide();"
                                           action="#{cadastroFichaClinicaBean.removerProcedimento}"
                                           process="@this" 
                                           update="procedimentosTable" />
                        </p:confirmDialog>
                    </p:tab>

                    <!-- Aba: Medicamentos -->
                    <p:tab title="Medicamentos">
                        <p:panelGrid columns="2" layout="grid"
                                   columnClasses="ui-grid-col-2,ui-grid-col-10"
                                   styleClass="panelgrid-noborder">

                            <p:outputLabel value="Medicamento" for="medicamento" />
                            <h:panelGroup>
                                <p:autoComplete id="medicamento" 
                                              dropdown="true"
                                              value="#{cadastroFichaClinicaBean.itemLoteSelecionado.lote}"
                                              completeMethod="#{cadastroFichaClinicaBean.completarLote}"
                                              var="lote" 
                                              itemLabel="#{lote.produto.nome} - Lote: #{lote.numeroLote}" 
                                              itemValue="#{lote}"
                                              forceSelection="true" 
                                              minQueryLength="2" 
                                              maxResults="10">
                                    <p:ajax update="labelEstoque" event="blur" />
                                </p:autoComplete>
                                <p:outputLabel
                                    value="Estoque: #{cadastroFichaClinicaBean.itemLoteSelecionado.lote.quantidade}"
                                    id="labelEstoque" 
                                    style="margin-left: 10px;" />
                            </h:panelGroup>
                            
                            <p:outputLabel value="Quantidade" />
                            <h:panelGroup>
                                <p:inputText value="#{cadastroFichaClinicaBean.quantidade}" />
                                <p:commandButton value="Adicionar" 
                                               icon="fa fa-plus"
                                               action="#{cadastroFichaClinicaBean.adicionarLote}"
                                               update="@form" 
                                               style="margin-left: 10px;" />
                            </h:panelGroup>
                        </p:panelGrid>

                        <p:dataTable id="itensTable" 
                                   style="margin-top: 20px"
                                   emptyMessage="Nenhum item adicionado!" 
                                   rows="5"
                                   value="#{cadastroFichaClinicaBean.itensLotes}" 
                                   var="item">
                            
                            <p:column headerText="Nome">
                                <h:outputText value="#{item.lote.produto.nome}" />
                            </p:column>
                            
                            <p:column headerText="Lote">
                                <h:outputText value="#{item.lote.numeroLote}" />
                            </p:column>
                            
                            <p:column headerText="Validade">
                                <h:outputText value="#{item.lote.validadeFormatada}" />
                            </p:column>
                            
                            <p:column headerText="QTD">
                                <h:outputText value="#{item.quantidade}" />
                            </p:column>
                            
                            <p:column headerText="Ações" style="width: 120px; text-align: center">
                                <p:commandButton icon="ui-icon-trash" 
                                               title="Excluir"
                                               oncomplete="PF('confirmacaoExclusao2').show()" 
                                               process="@this"
                                               update="form:tabViewAtendimento:confirmacaoExclusaoDialog2">
                                    <f:setPropertyActionListener
                                        target="#{cadastroFichaClinicaBean.itemLoteSelecionado}"
                                        value="#{item}" />
                                </p:commandButton>
                            </p:column>
                        </p:dataTable>

                        <p:confirmDialog header="Remover Item"
                                       message="Tem certeza que deseja remover este item?"
                                       widgetVar="confirmacaoExclusao2" 
                                       id="confirmacaoExclusaoDialog2">
                            <p:button value="Não" 
                                     icon="fa fa-close"
                                     onclick="PF('confirmacaoExclusao2').hide(); return false;" />
                            <p:commandButton value="Sim" 
                                           icon="fa fa-check"
                                           oncomplete="PF('confirmacaoExclusao2').hide();"
                                           action="#{cadastroFichaClinicaBean.removerProduto}"
                                           process="@this" 
                                           update="itensTable" />
                        </p:confirmDialog>
                    </p:tab>

                    <!-- Aba: Microchip -->
                    <p:tab title="Microchip">
                        <p:panelGrid columns="2" layout="grid"
                                   columnClasses="ui-grid-col-2, ui-grid-col-4"
                                   styleClass="panelgrid-noborder">

                            <p:outputLabel value="Número do Microchip:" for="microchip" />
                            <p:inputText id="microchip"
                                       value="#{cadastroFichaClinicaBean.numeroMicrochip}"
                                       placeholder="Informe o número do microchip" />
                        </p:panelGrid>
                    </p:tab>
                </p:tabView>
            </p:fieldset>

        </h:form>
    </ui:define>
</ui:composition>
