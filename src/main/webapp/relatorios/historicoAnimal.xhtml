<ui:composition xmlns="http://www.w3.org/1999/xhtml" xmlns:h="http://xmlns.jcp.org/jsf/html"
    xmlns:f="http://xmlns.jcp.org/jsf/core" xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
    xmlns:p="http://primefaces.org/ui" template="/WEB-INF/template/Layout.xhtml">

    <ui:define name="content">


        <h:form>
            <div class="topo">

                <!-- Título -->
                <h1 class="aw-page-title">Ficha Clínica: <span
                        style="color: red;">#{historicoAnimalBean.nomeAnimal}</span></h1>

                <!-- Botão de Impressão -->
                <p:commandButton value="Imprimir Ficha Clínica" icon="fa fa-file-pdf-o" styleClass="ui-button-info"
                    style="margin-bottom: 10px;" action="#{historicoAnimalBean.imprimirFichaClinica}" ajax="false" />

            </div>
            <!-- Botão de Impressão Simples 
            <p:commandButton value="Impressão Simples" 
                           icon="pi pi-file" 
                           styleClass="ui-button-secondary"
                           style="margin-bottom: 10px; margin-left: 10px;"
                           onclick="window.print(); return false;" /> -->


            <!-- Ficha Clínica (dados principais) -->
            <p:panel header="Dados da Ficha Clínica">
                <h:panelGrid columns="2" style="width:100%; vertical-align:top;">
                    <h:panelGroup>
                        <div class="container">
                            <div class="columns">
                                <div class="item">
                                    <h:outputText value="Data de Entrada: " styleClass="destaque-topico" />
                                    <h:outputText value="#{historicoAnimalBean.fichaClinica.dataEntrada.time}">
                                        <f:convertDateTime pattern="dd/MM/yyyy" />
                                    </h:outputText>
                                </div>
                                <div class="item">
                                    <h:outputText value="Proprietário: " styleClass="destaque-topico" />
                                    <h:outputText value="#{historicoAnimalBean.fichaClinica.nomeProprietario}" />
                                </div>
                                <div class="item">
                                    <h:outputText value="CPF: " styleClass="destaque-topico" />
                                    <h:outputText value="#{historicoAnimalBean.fichaClinica.cpfProprietario}" />
                                </div>
                            </div>
                            <div class="columns" style="margin-left: 50px;">
                                <div class="item">
                                    <h:outputText value="Endereço: " styleClass="destaque-topico" />
                                    <h:outputText value="#{historicoAnimalBean.fichaClinica.enderecoProprietario}" />
                                    <h:outputText value=", #{historicoAnimalBean.fichaClinica.numeroEndereco}"
                                        rendered="#{not empty historicoAnimalBean.fichaClinica.numeroEndereco}" />
                                </div>
                                <div class="item">
                                    <h:outputText value="Bairro: " styleClass="destaque-topico" />
                                    <h:outputText value="#{historicoAnimalBean.fichaClinica.bairroProprietario}" />
                                </div>
                                <div class="item">
                                    <h:outputText value="Contato: " styleClass="destaque-topico" />
                                    <h:outputText value="#{historicoAnimalBean.fichaClinica.contatoProprietario}" />
                                </div>
                            </div>
                        </div>
                        <br />
                        <h:panelGrid columns="6" cellpadding="4">
                            <h:outputText value="Espécie:" styleClass="destaque-topico" />
                            <h:outputText value="#{historicoAnimalBean.fichaClinica.especie}" />
                            <h:outputText value="Raça:" styleClass="destaque-topico" />
                            <h:outputText value="#{historicoAnimalBean.fichaClinica.raca}" />
                            <h:outputText value="Nome:" styleClass="destaque-topico" />
                            <h:outputText value="#{historicoAnimalBean.nomeAnimal}" />

                            <h:outputText value="Idade:" styleClass="destaque-topico" />
                            <h:outputText value="#{historicoAnimalBean.fichaClinica.idade}" />
                            <h:outputText value="Sexo:" styleClass="destaque-topico" />
                            <h:outputText value="#{historicoAnimalBean.fichaClinica.sexo}" />
                            <h:outputText value="Cor:" styleClass="destaque-topico" />
                            <h:outputText value="#{historicoAnimalBean.fichaClinica.cor}" />

                            <h:outputText value="Microchip:" styleClass="destaque-topico" />
                            <h:panelGroup>
                                <h:outputText value="#{historicoAnimalBean.fichaClinica.numeroMicrochip}" 
                                    rendered="#{not empty historicoAnimalBean.fichaClinica.numeroMicrochip}" />
                                <h:outputText value="Sem Microchip" 
                                    style="color: #999999; font-style: italic;"
                                    rendered="#{empty historicoAnimalBean.fichaClinica.numeroMicrochip}" />
                            </h:panelGroup>
                            <h:outputText value="" />
                        </h:panelGrid>
                    </h:panelGroup>
                    <h:panelGroup style="display: flex; justify-content: center; align-items: center;">
                        <img src="/uploads/#{not empty historicoAnimalBean.fotoAnimal ? historicoAnimalBean.fotoAnimal : 'no_image.jpg'}"
                            style="border:1px solid #ccc; border-radius:8px; width: auto; height: 160px;"
                            alt="Foto do animal" />
                    </h:panelGroup>
                </h:panelGrid>
            </p:panel>

            <style>
                .topo {
                    display: flex;
                    justify-content: space-between;
                    align-items: baseline;
                    margin: 0;
                    padding: 0;
                }

                .destaque-topico {
                    font-weight: bold;
                    color: #2a3f54;
                }

                .container {
                    display: flex;
                }

                .item {
                    flex: 1 1 30%;
                    box-sizing: border-box;
                    padding: 5px;
                }

                /* Estilos para tabela de medicamentos */
                .medicamentos-table {
                    width: 100%;
                    margin-top: 10px;
                    border-collapse: collapse;
                }

                .medicamentos-table th {
                    background-color: #f8f9fa;
                    padding: 8px;
                    text-align: left;
                    font-weight: bold;
                    border: 1px solid #dee2e6;
                }

                .medicamentos-table td {
                    padding: 6px 8px;
                    border: 1px solid #dee2e6;
                }

                /* Estilos para impressão */
                @media print {

                    /* Ocultar botão de impressão e elementos desnecessários */
                    .ui-button-info,
                    .ui-panel-titlebar,
                    .ui-accordionpanel-header {
                        display: none !important;
                    }

                    /* Ajustar layout para impressão */
                    body {
                        font-size: 12px;
                        color: black;
                        background: white;
                    }

                    .aw-page-title {
                        font-size: 18px;
                        margin-bottom: 20px;
                        text-align: center;
                    }

                    .ui-panel-content {
                        border: none !important;
                        padding: 10px !important;
                    }

                    /* Forçar quebra de página após cada atendimento */
                    .ui-accordion-content {
                        page-break-inside: avoid;
                        margin-bottom: 15px;
                        border: 1px solid #ccc;
                        padding: 10px;
                    }

                    /* Ajustar imagem para impressão */
                    img {
                        max-width: 200px;
                        height: auto;
                    }

                    /* Melhorar contraste para impressão */
                    .destaque-topico {
                        color: black !important;
                        font-weight: bold;
                    }

                    /* Estilos para tabela de medicamentos na impressão */
                    .medicamentos-table {
                        width: 100% !important;
                        border-collapse: collapse !important;
                        margin-top: 10px !important;
                        font-size: 11px !important;
                    }

                    .medicamentos-table th,
                    .medicamentos-table td {
                        border: 1px solid black !important;
                        padding: 4px !important;
                        text-align: left !important;
                    }

                    .medicamentos-table th {
                        background-color: #f0f0f0 !important;
                        font-weight: bold !important;
                    }
                }
            </style>

            <br />

            <!-- Histórico Clínico (accordion retrátil) -->
            <p:panel header="Histórico de Atendimentos">
                <p:accordionPanel var="historico" value="#{historicoAnimalBean.lista}">
                    <p:tab title="Atendimento em #{historico.data}">
                        <h:panelGrid columns="2" cellpadding="4">

                            <h:outputText value="Tipo de Atendimento:" styleClass="destaque-topico"
                                rendered="#{not empty historico.tipoAtendimento}" />
                            <h:outputText value="#{historico.tipoAtendimento}"
                                rendered="#{not empty historico.tipoAtendimento}" />


                            <h:outputText value="Procedimento:" styleClass="destaque-topico"
                                rendered="#{not empty historico.procedimento}" />
                            <h:outputText value="#{historico.procedimento}"
                                rendered="#{not empty historico.procedimento}" />


                            <h:outputText value="Diagnóstico:" styleClass="destaque-topico" />
                            <h:outputText value="#{historico.diagnostico}" escape="false" />


                            <h:outputText value="Escore Corporal:" styleClass="destaque-topico"
                                rendered="#{not empty historico.escoreCorporal}" />
                            <h:outputText value="#{historico.escoreCorporal}"
                                rendered="#{not empty historico.escoreCorporal}" />


                            <h:outputText value="Peso:" styleClass="destaque-topico"
                                rendered="#{not empty historico.peso}" />
                            <h:outputText value="#{historico.peso} kg" rendered="#{not empty historico.peso}" />


                            <h:outputText value="FC:" styleClass="destaque-topico"
                                rendered="#{not empty historico.fc}" />
                            <h:outputText value="#{historico.fc} bpm" rendered="#{not empty historico.fc}" />


                            <h:outputText value="FR:" styleClass="destaque-topico"
                                rendered="#{not empty historico.fr}" />
                            <h:outputText value="#{historico.fr} irpm" rendered="#{not empty historico.fr}" />


                            <h:outputText value="Temperatura:" styleClass="destaque-topico"
                                rendered="#{not empty historico.temperatura}" />
                            <h:outputText value="#{historico.temperatura} °C"
                                rendered="#{not empty historico.temperatura}" />


                            <h:outputText value="Tratamento:" styleClass="destaque-topico"
                                rendered="#{not empty historico.tratamento}" />
                            <h:outputText value="#{historico.tratamento}"
                                rendered="#{not empty historico.tratamento}" />

                            <h:outputText value="Responsável:" styleClass="destaque-topico" />
                            <h:outputText value="#{historico.responsavel}" />

                            <h:outputText value="Situação:" styleClass="destaque-topico" />
                            <h:outputText value="#{historico.statusSolicitacao}" />

                        </h:panelGrid>
                        
                        <!-- Medicamentos utilizados no atendimento -->
                        <h:panelGroup rendered="#{not empty historico.medicamentos}">
                            <br/>
                            <h:outputText value="Medicamentos Utilizados:" styleClass="destaque-topico" style="font-size: 14px; margin-bottom: 10px; display: block;" />
                            
                            <p:dataTable value="#{historico.medicamentos}" var="medicamento" 
                                        emptyMessage="Nenhum medicamento foi utilizado neste atendimento"
                                        styleClass="medicamentos-table"
                                        style="margin-top: 10px; font-size: 12px;">
                                
                                <p:column headerText="Medicamento">
                                    <h:outputText value="#{historico.getNomeProduto(medicamento)}" />
                                </p:column>
                                
                                <p:column headerText="Quantidade">
                                    <h:outputText value="#{historico.getQuantidadeMedicamento(medicamento)}" />
                                </p:column>
                                
                                <p:column headerText="Lote">
                                    <h:outputText value="#{historico.getNumeroLote(medicamento)}" />
                                </p:column>
                                
                                <p:column headerText="Validade">
                                    <h:outputText value="#{historico.getDataValidadeFormatada(medicamento)}" />
                                </p:column>
                                
                            </p:dataTable>
                        </h:panelGroup>
                    </p:tab>
                </p:accordionPanel>
            </p:panel>
        </h:form>
    </ui:define>
</ui:composition>